<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UV Pride Remapper</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --text: #f0f0f8;
    --muted: #666680;
    --accent: #ff6eb4;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(255,110,180,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,110,180,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 48px 32px;
  }

  header { margin-bottom: 48px; }

  .title {
    font-family: 'Syne', sans-serif;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1;
    background: linear-gradient(135deg, #ff6eb4 0%, #55cdfc 60%, #f7a8b8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle {
    margin-top: 10px;
    color: var(--muted);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .top-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 900px) {
    .top-row { grid-template-columns: 1fr 1fr; }
  }

  @media (max-width: 580px) {
    .top-row { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 24px;
  }

  .panel-label {
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 16px;
  }

  .dropzone {
    border: 1px dashed var(--border);
    border-radius: 4px;
    padding: 32px 16px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
  }
  .dropzone:hover, .dropzone.dragover { border-color: var(--accent); background: rgba(255,110,180,0.04); }
  .dropzone-icon { font-size: 1.8rem; margin-bottom: 10px; display: block; }
  .dropzone p { color: var(--muted); font-size: 0.7rem; line-height: 1.6; }
  .dropzone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

  .preview-wrap {
    margin-top: 14px;
    border-radius: 4px;
    overflow: hidden;
    background: #000;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .preview-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }

  .search-wrap { position: relative; margin-bottom: 12px; }
  .search-wrap input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 12px 10px 32px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-wrap::before {
    content: '⌕';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 1rem;
    pointer-events: none;
  }

  .flag-scroll {
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
    margin-bottom: 20px;
  }
  .flag-scroll::-webkit-scrollbar { width: 4px; }
  .flag-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .flag-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

  .flag-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 10px 8px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    text-align: left;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.6rem;
  }
  .flag-btn:hover { border-color: #444460; background: var(--surface2); }
  .flag-btn.selected { border-color: var(--accent); background: rgba(255,110,180,0.08); }

  .flag-swatch { display: flex; height: 8px; border-radius: 2px; overflow: hidden; margin-bottom: 7px; }
  .flag-swatch span { flex: 1; }
  .flag-name { color: var(--text); font-weight: 700; line-height: 1.3; }

  .sliders { margin-bottom: 20px; }
  .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .slider-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.08em; width: 85px; flex-shrink: 0; }

  input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }
  .slider-val { font-size: 0.6rem; color: var(--muted); width: 30px; text-align: right; flex-shrink: 0; }

  .btn {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: 4px;
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn:hover:not(:disabled) { opacity: 0.85; }
  .btn:active:not(:disabled) { transform: scale(0.99); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn.secondary {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    margin-top: 10px;
  }

  .progress-wrap { margin-top: 14px; display: none; }
  .progress-wrap.visible { display: block; }
  .progress-bar-bg { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff6eb4, #55cdfc);
    width: 0%;
    transition: width 0.3s;
    border-radius: 2px;
  }
  .progress-label { font-size: 0.62rem; color: var(--muted); margin-top: 6px; letter-spacing: 0.08em; }

  .right-col { display: flex; flex-direction: column; gap: 20px; }

  .output-panel { display: none; }
  .output-panel.visible { display: block; }

  .before-after { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  @media (max-width: 600px) { .before-after { grid-template-columns: 1fr; } }

  .tag {
    display: inline-block;
    font-size: 0.58rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 3px 7px;
    border-radius: 2px;
    margin-bottom: 10px;
  }
  .tag.before { background: rgba(255,255,255,0.05); color: var(--muted); }
  .tag.after { background: rgba(255,110,180,0.15); color: var(--accent); }

  .palette-editor { border-top: 1px solid var(--border); padding-top: 18px; margin-top: 4px; }
  .palette-editor-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 14px; }

  .palette-swatches { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 14px; }

  .swatch-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .swatch-color {
    width: 34px; height: 34px;
    border-radius: 4px;
    border: 2px solid transparent;
    transition: border-color 0.15s, transform 0.1s;
    position: relative;
    cursor: pointer;
  }
  .swatch-color:hover { transform: scale(1.1); border-color: rgba(255,255,255,0.3); }
  .swatch-color.swap-selected { border-color: #fff; box-shadow: 0 0 0 2px var(--accent); }
  /* tiny edit pencil in corner opens color picker */
  .swatch-edit-btn {
    position: absolute;
    bottom: 2px; right: 2px;
    width: 13px; height: 13px;
    background: rgba(0,0,0,0.55);
    border-radius: 2px;
    font-size: 8px;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    pointer-events: all;
  }
  .swatch-edit-btn input[type=color] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%; height: 100%;
  }
  .swatch-label { font-size: 0.52rem; color: var(--muted); max-width: 38px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }

  .swap-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }
  .swap-slot {
    width: 34px; height: 34px;
    border-radius: 4px;
    border: 2px dashed var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.6rem; color: var(--muted);
    transition: border-color 0.15s;
    flex-shrink: 0;
  }
  .swap-slot.filled { border-style: solid; border-color: #fff; }
  .swap-arrow { color: var(--muted); font-size: 1rem; }
  .swap-hint-text { font-size: 0.6rem; color: var(--muted); flex: 1; min-width: 100px; }
  .btn.swap-btn {
    width: auto;
    padding: 8px 14px;
    font-size: 0.65rem;
    flex-shrink: 0;
  }
  .btn.swap-btn:disabled { opacity: 0.25; }
  .swatch-color.swap-selected { border-color: #fff; box-shadow: 0 0 0 2px var(--accent); }

  .no-content { font-size: 0.72rem; color: var(--muted); text-align: center; padding: 40px 20px; line-height: 1.8; }

  .help-text { font-size: 0.6rem; color: var(--muted); line-height: 1.7; margin-bottom: 12px; }

  .how-to { margin-top: 0; }
  .how-to-step { display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start; }
  .step-num {
    width: 20px; height: 20px;
    border-radius: 50%;
    background: rgba(255,110,180,0.15);
    border: 1px solid rgba(255,110,180,0.3);
    color: var(--accent);
    font-size: 0.58rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .step-text { font-size: 0.62rem; color: var(--muted); line-height: 1.6; }
  .step-text strong { color: var(--text); }

  canvas { display: none; }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 class="title">UV Pride<br>Remapper</h1>
    <p class="subtitle">Recolor UV texture maps with pride flag palettes</p>
  </header>

  <div class="layout">
    <div class="top-row">
      <!-- Col 1: upload -->
      <div class="panel">
        <div class="panel-label">01 — Upload UV Map</div>
        <div class="dropzone" id="dropzone">
          <input type="file" id="fileInput" accept="image/*">
          <span class="dropzone-icon">⬡</span>
          <p>Drop your UV map here<br>or click to browse</p>
        </div>
        <div class="preview-wrap" id="inputPreview" style="display:none">
          <img id="inputImg" alt="Input UV map">
        </div>
      </div>

      <!-- Col 2: flags + controls -->
      <div class="panel">
        <div class="panel-label">02 — Choose Flag</div>
        <div class="search-wrap">
          <input type="text" id="flagSearch" placeholder="Search flags...">
        </div>
        <div class="flag-scroll">
          <div class="flag-grid" id="flagGrid"></div>
        </div>

        <!-- Custom palette editor - shown only when custom flag selected -->
        <div id="customPaletteEditor" style="display:none; margin-bottom:16px;">
          <div class="panel-label">Pick your colors</div>
          <div id="customColorPickers" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px;"></div>
          <p class="help-text">Each color maps to a region in the texture. Adjust to build your own flag palette.</p>
        </div>

        <div class="panel-label">03 — Fine-tune</div>
        <div class="sliders">
          <div class="slider-row">
            <span class="slider-label">Color blend</span>
            <input type="range" id="blendSlider" min="20" max="100" value="100">
            <span class="slider-val" id="blendVal">100%</span>
          </div>
          <div class="slider-row">
            <span class="slider-label">Sectors</span>
            <input type="range" id="sectorSlider" min="4" max="48" value="24" step="2">
            <span class="slider-val" id="sectorVal">24</span>
          </div>
          <div class="slider-row">
            <span class="slider-label">Snap thresh</span>
            <input type="range" id="snapSlider" min="10" max="80" value="50">
            <span class="slider-val" id="snapVal">50</span>
          </div>
        </div>

        <button class="btn" id="processBtn" disabled>Process →</button>
        <div class="progress-wrap" id="progressWrap">
          <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
          <div class="progress-label" id="progressLabel">Analyzing pixels...</div>
        </div>
      </div>

      <!-- Col 3: instructions -->
      <div class="right-col">
      <div class="panel" id="placeholderPanel">
        <div class="panel-label">How it works</div>
        <div class="how-to">
          <div class="how-to-step">
            <div class="step-num">1</div>
            <div class="step-text"><strong>Upload your UV map</strong> — drag and drop or click to browse. PNG, JPG supported.</div>
          </div>
          <div class="how-to-step">
            <div class="step-num">2</div>
            <div class="step-text"><strong>Choose a flag</strong> — search or scroll through 17 pride flags. The original texture colors will be remapped to the flag's palette.</div>
          </div>
          <div class="how-to-step">
            <div class="step-num">3</div>
            <div class="step-text"><strong>Fine-tune the sliders</strong> before processing:
              <br>• <strong>Color blend</strong> — how strongly colors replace the originals. Higher = more vivid.
              <br>• <strong>Sectors</strong> — how many alternating patches the neutral areas split into. More = finer checkerboard, fewer = bigger bold zones.
              <br>• <strong>Snap threshold</strong> — how aggressively blurry edge pixels get snapped to the nearest flag color. Higher = cleaner edges.
            </div>
          </div>
          <div class="how-to-step">
            <div class="step-num">4</div>
            <div class="step-text"><strong>Hit Process</strong> — the result appears with a before/after preview.</div>
          </div>
          <div class="how-to-step">
            <div class="step-num">5</div>
            <div class="step-text"><strong>Edit colors</strong> — click any color swatch in the result palette to pick a custom color. Use <strong>Swap</strong> to flip two colors (e.g. if pink and blue are the wrong way round). Then hit <strong>Reapply</strong> to regenerate.</div>
          </div>
          <div class="how-to-step">
            <div class="step-num">6</div>
            <div class="step-text"><strong>Download</strong> — saves a full-resolution PNG ready to use in your 3D software.</div>
          </div>
        </div>
      </div>

      </div>
    </div><!-- end top-row -->

    <!-- Output panel spans full width below -->
    <div class="panel output-panel" id="outputPanel">
        <div class="panel-label">Result</div>
        <div class="before-after">
          <div>
            <div class="tag before">Before</div>
            <div class="preview-wrap"><img id="beforeThumb" alt="Before"></div>
          </div>
          <div>
            <div class="tag after">After</div>
            <div class="preview-wrap"><img id="afterThumb" alt="After"></div>
          </div>
        </div>

        <div class="palette-editor">
          <div class="palette-editor-label">Swap colors — click two swatches then hit Swap</div>
          <div class="palette-swatches" id="paletteSwatches"></div>
          <div class="swap-bar">
            <div class="swap-slot" id="swapSlot1">?</div>
            <div class="swap-arrow">⇄</div>
            <div class="swap-slot" id="swapSlot2">?</div>
            <span class="swap-hint-text" id="swapHint">Click two swatches to swap them</span>
            <button class="btn swap-btn" id="swapBtn" disabled>Swap + Reprocess →</button>
          </div>
        </div>

        <button class="btn secondary" id="downloadBtn" style="margin-top:10px;">↓ Download PNG</button>
      </div>
  </div>
</div>

<canvas id="canvas"></canvas>

<script>
const FLAGS = [
  { id:'trans', name:'Transgender',
    swatches:['#55cdfc','#f7a8b8','#ffffff','#f7a8b8','#55cdfc'],
    colors:{ pink:[247,168,184], blue:[85,205,252], white:[255,255,255], slate:[110,160,200] },
    map:()=>({ red:'pink', orange:'blue', whitePink:'pink', whiteBlue:'blue', brownPink:'pink', brownBlue:'blue', dgray:'slate', black:'white' })
  },
  { id:'progress', name:'Progress Pride',
    swatches:['#e40303','#ff8c00','#ffed00','#008026','#004dff','#750787','#ffffff','#ffafc8','#74d7ee','#613915','#000000'],
    colors:{ red:[228,3,3], orange:[255,140,0], yellow:[255,237,0], green:[0,128,38], blue:[0,77,255], violet:[117,7,135], white:[255,255,255], tpink:[255,175,200], tblue:[116,215,238], brown:[97,57,21], black:[26,26,26] },
    rainbowMode: true,
    rainbowKeys: ['red','orange','yellow','green','blue','violet','tpink','tblue','brown','white'],
    map:()=>({ red:'red', orange:'orange', whitePink:'tpink', whiteBlue:'tblue', brownPink:'brown', brownBlue:'violet', dgray:'blue', black:'black' })
  },
  { id:'rainbow', name:'Rainbow',
    swatches:['#e40303','#ff8c00','#ffed00','#008026','#004dff','#750787'],
    colors:{ red:[228,3,3], orange:[255,140,0], yellow:[255,237,0], green:[0,128,38], blue:[0,77,255], violet:[117,7,135] },
    rainbowMode: true,
    map:()=>({ red:'red', orange:'orange', whitePink:'yellow', whiteBlue:'green', brownPink:'blue', brownBlue:'violet', dgray:'blue', black:'violet' })
  },

  { id:'bi', name:'Bisexual',
    swatches:['#d60270','#d60270','#9b4f96','#0038a8','#0038a8'],
    colors:{ pink:[214,2,112], purple:[155,79,150], blue:[0,56,168], white:[255,255,255] },
    rainbowMode: true,
    rainbowKeys: ['pink','pink','purple','blue','blue','white'],
    map:()=>({ red:'pink', orange:'blue', whitePink:'pink', whiteBlue:'blue', brownPink:'purple', brownBlue:'blue', dgray:'purple', black:'white' })
  },
  { id:'pan', name:'Pansexual',
    swatches:['#ff218c','#ff218c','#ffd800','#ffd800','#21b1ff'],
    colors:{ pink:[255,33,140], yellow:[255,216,0], blue:[33,177,255], white:[255,255,255] },
    rainbowMode: true,
    rainbowKeys: ['pink','pink','yellow','blue','blue','white'],
    map:()=>({ red:'pink', orange:'yellow', whitePink:'pink', whiteBlue:'blue', brownPink:'yellow', brownBlue:'blue', dgray:'blue', black:'white' })
  },
  { id:'lesbian', name:'Lesbian',
    swatches:['#d52d00','#ef7627','#ff9a56','#ffffff','#d162a4','#b55690','#a50062'],
    colors:{ orange:[239,118,39], peach:[255,154,86], white:[255,255,255], pink:[209,98,164], magenta:[165,0,98] },
    rainbowMode: true,
    rainbowKeys: ['magenta','orange','peach','white','pink','magenta'],
    map:()=>({ red:'magenta', orange:'orange', whitePink:'peach', whiteBlue:'pink', brownPink:'orange', brownBlue:'pink', dgray:'pink', black:'white' })
  },
  { id:'gaymen', name:'Gay Men',
    swatches:['#078d70','#26ceaa','#98e8c1','#ffffff','#7bade2','#5049cc','#3d1a8e'],
    colors:{ teal:[7,141,112], mint:[38,206,170], seafoam:[152,232,193], white:[255,255,255], periwinkle:[123,173,226], indigo:[80,73,204], navy:[61,26,142] },
    map:()=>({ red:'indigo', orange:'teal', whitePink:'seafoam', whiteBlue:'periwinkle', brownPink:'mint', brownBlue:'indigo', dgray:'navy', black:'white' })
  },
  { id:'ace', name:'Asexual',
    swatches:['#1a1a1a','#a3a3a3','#ffffff','#810081'],
    colors:{ black:[26,26,26], gray:[163,163,163], white:[255,255,255], purple:[129,0,129] },
    map:()=>({ red:'purple', orange:'gray', whitePink:'white', whiteBlue:'gray', brownPink:'purple', brownBlue:'gray', dgray:'gray', black:'black' })
  },
  { id:'aromantic', name:'Aromantic',
    swatches:['#3aa63f','#abd47a','#ffffff','#aaaaaa','#000000'],
    colors:{ green:[58,166,63], lightgreen:[171,212,122], white:[255,255,255], gray:[170,170,170], black:[20,20,20] },
    map:()=>({ red:'green', orange:'lightgreen', whitePink:'white', whiteBlue:'lightgreen', brownPink:'green', brownBlue:'gray', dgray:'gray', black:'black' })
  },
  { id:'aroace', name:'Aroace',
    swatches:['#e38d00','#e7c601','#ffffff','#5faad7','#1f3554'],
    colors:{ orange:[227,141,0], gold:[231,198,1], white:[255,255,255], blue:[95,170,215], navy:[31,53,84] },
    map:()=>({ red:'orange', orange:'gold', whitePink:'white', whiteBlue:'blue', brownPink:'orange', brownBlue:'navy', dgray:'navy', black:'navy' })
  },
  { id:'nonbinary', name:'Non-Binary',
    swatches:['#fcf434','#ffffff','#9c59d1','#2d2d2d'],
    colors:{ yellow:[252,244,52], white:[255,255,255], purple:[156,89,209], dark:[45,45,45] },
    map:()=>({ red:'yellow', orange:'purple', whitePink:'white', whiteBlue:'yellow', brownPink:'purple', brownBlue:'yellow', dgray:'purple', black:'dark' })
  },
  { id:'genderfluid', name:'Genderfluid',
    swatches:['#ff76a3','#ffffff','#bf11d7','#000000','#303cbe'],
    colors:{ pink:[255,118,163], white:[255,255,255], violet:[191,17,215], black:[20,20,20], blue:[48,60,190] },
    map:()=>({ red:'pink', orange:'violet', whitePink:'pink', whiteBlue:'blue', brownPink:'violet', brownBlue:'blue', dgray:'blue', black:'black' })
  },
  { id:'genderqueer', name:'Genderqueer',
    swatches:['#ad7ad8','#ffffff','#6a853a'],
    colors:{ lavender:[173,122,216], white:[255,255,255], olive:[106,133,58] },
    map:()=>({ red:'lavender', orange:'olive', whitePink:'lavender', whiteBlue:'white', brownPink:'olive', brownBlue:'lavender', dgray:'olive', black:'white' })
  },
  { id:'agender', name:'Agender',
    swatches:['#000000','#b4b4b4','#ffffff','#b3ed7f'],
    colors:{ black:[20,20,20], gray:[180,180,180], white:[255,255,255], green:[179,237,127] },
    map:()=>({ red:'green', orange:'gray', whitePink:'white', whiteBlue:'green', brownPink:'gray', brownBlue:'green', dgray:'gray', black:'black' })
  },


  { id:'demisexual', name:'Demisexual',
    swatches:['#000000','#a4a4a4','#ffffff','#810081'],
    colors:{ black:[20,20,20], gray:[164,164,164], white:[255,255,255], purple:[129,0,129] },
    map:()=>({ red:'purple', orange:'gray', whitePink:'white', whiteBlue:'gray', brownPink:'purple', brownBlue:'gray', dgray:'gray', black:'black' })
  },
  { id:'intersex', name:'Intersex',
    swatches:['#ffd800','#ffd800','#7902aa','#ffd800','#ffd800'],
    colors:{ yellow:[255,216,0], purple:[121,2,170], white:[255,255,255] },
    map:()=>({ red:'purple', orange:'yellow', whitePink:'yellow', whiteBlue:'purple', brownPink:'yellow', brownBlue:'purple', dgray:'yellow', black:'purple' })
  },


  { id:'bigender', name:'Bigender',
    swatches:['#c479a2','#eda5cd','#ffffff','#d5c7e8','#9ac7e8','#6d82d1'],
    colors:{ mauve:[196,121,162], pink:[237,165,205], white:[255,255,255], lavender:[213,199,232], lightblue:[154,199,232], blue:[109,130,209] },
    map:()=>({ red:'mauve', orange:'blue', whitePink:'pink', whiteBlue:'lightblue', brownPink:'mauve', brownBlue:'lavender', dgray:'blue', black:'white' })
  },

  { id:'sapphic', name:'Sapphic',
    swatches:['#fd76b4','#ffffff','#fd76b4'],
    colors:{ pink:[253,118,180], white:[255,255,255], green:[101,170,101] },
    map:()=>({ red:'pink', orange:'green', whitePink:'pink', whiteBlue:'white', brownPink:'green', brownBlue:'pink', dgray:'green', black:'white' })
  },

  { id:'custom', name:'✦ Build Your Own',
    swatches:['#ff0000','#ff8800','#ffff00','#00cc00','#0000ff','#8800ff'],
    custom: true,
    colors:{
      color1:[255,0,0], color2:[255,136,0], color3:[255,255,0],
      color4:[0,204,0], color5:[0,0,255], color6:[136,0,255]
    },
    get swatchColors() { return Object.values(this.colors).map(rgb => rgbToHex(...rgb)); },
    map:()=>({ red:'color1', orange:'color2', whitePink:'color3', whiteBlue:'color4', brownPink:'color5', brownBlue:'color6', dgray:'color5', black:'color6' })
  },

];

// ─── UI ────────────────────────────────────────────────────────────────────
const flagGrid = document.getElementById('flagGrid');
const flagSearch = document.getElementById('flagSearch');
let selectedFlag = FLAGS[0];
let customColors = null;

function buildFlagGrid(filter = '') {
  flagGrid.innerHTML = '';
  FLAGS.filter(f => f.name.toLowerCase().includes(filter.toLowerCase())).forEach(flag => {
    const btn = document.createElement('button');
    btn.className = 'flag-btn' + (flag.id === selectedFlag.id ? ' selected' : '');
    const sw = document.createElement('div');
    sw.className = 'flag-swatch';
    const swatchList = flag.swatchColors || flag.swatches;
    swatchList.forEach(c => { const s=document.createElement('span'); s.style.background=c; sw.appendChild(s); });
    const nm = document.createElement('div');
    nm.className = 'flag-name';
    nm.textContent = flag.name;
    btn.appendChild(sw);
    btn.appendChild(nm);
    btn.addEventListener('click', () => {
      document.querySelectorAll('.flag-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedFlag = flag;
      customColors = null;
      toggleCustomEditor(flag);
    });
    flagGrid.appendChild(btn);
  });
}

function toggleCustomEditor(flag) {
  const editor = document.getElementById('customPaletteEditor');
  const pickers = document.getElementById('customColorPickers');
  if (!flag.custom) { editor.style.display = 'none'; return; }
  editor.style.display = 'block';
  pickers.innerHTML = '';
  const labels = { color1:'Region 1', color2:'Region 2', color3:'Region 3', color4:'Region 4', color5:'Region 5', color6:'Region 6' };
  Object.entries(flag.colors).forEach(([key, rgb]) => {
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;gap:4px;';
    const picker = document.createElement('input');
    picker.type = 'color';
    picker.value = rgbToHex(...rgb);
    picker.style.cssText = 'width:36px;height:36px;border:none;cursor:pointer;border-radius:4px;padding:0;background:none;';
    picker.addEventListener('input', () => {
      flag.colors[key] = hexToRgb(picker.value);
      // update swatch strip on the button
      buildFlagGrid(document.getElementById('flagSearch').value);
      // re-select it
      document.querySelectorAll('.flag-btn').forEach(b => {
        if (b.querySelector('.flag-name').textContent === flag.name) b.classList.add('selected');
      });
    });
    const lbl = document.createElement('div');
    lbl.style.cssText = 'font-size:0.5rem;color:var(--muted);text-align:center;';
    lbl.textContent = labels[key] || key;
    wrap.appendChild(picker);
    wrap.appendChild(lbl);
    pickers.appendChild(wrap);
  });
}
buildFlagGrid();
flagSearch.addEventListener('input', () => buildFlagGrid(flagSearch.value));

// Sliders
const blendSlider = document.getElementById('blendSlider');
const sectorSlider = document.getElementById('sectorSlider');
const snapSlider = document.getElementById('snapSlider');
blendSlider.addEventListener('input', () => document.getElementById('blendVal').textContent = blendSlider.value+'%');
sectorSlider.addEventListener('input', () => document.getElementById('sectorVal').textContent = sectorSlider.value);
snapSlider.addEventListener('input', () => document.getElementById('snapVal').textContent = snapSlider.value);

// Upload
let uploadedImage = null;
const fileInput = document.getElementById('fileInput');
const dropzone = document.getElementById('dropzone');
const processBtn = document.getElementById('processBtn');

dropzone.addEventListener('dragover', e=>{e.preventDefault();dropzone.classList.add('dragover');});
dropzone.addEventListener('dragleave', ()=>dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', e=>{e.preventDefault();dropzone.classList.remove('dragover');if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0]);});
fileInput.addEventListener('change', ()=>{if(fileInput.files[0])loadFile(fileInput.files[0]);});

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      uploadedImage = img;
      document.getElementById('inputImg').src = e.target.result;
      document.getElementById('inputPreview').style.display = 'flex';
      processBtn.disabled = false;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ─── PROCESSING ─────────────────────────────────────────────────────────────
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', {willReadFrequently:true});
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const progressLabel = document.getElementById('progressLabel');
const outputPanel = document.getElementById('outputPanel');
const placeholderPanel = document.getElementById('placeholderPanel');


processBtn.addEventListener('click', ()=>processImage());


function setProgress(pct, label) { progressFill.style.width=pct+'%'; progressLabel.textContent=label; }
function dist3(r1,g1,b1,r2,g2,b2){return Math.sqrt((r1-r2)**2+(g1-g2)**2+(b1-b2)**2);}
function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>Math.round(v).toString(16).padStart(2,'0')).join('');}
function hexToRgb(hex){return[parseInt(hex.slice(1,3),16),parseInt(hex.slice(3,5),16),parseInt(hex.slice(5,7),16)];}

function buildPaletteEditor(palette) {
  const ps = document.getElementById('paletteSwatches');
  ps.innerHTML = '';
  swapSelection = [null, null];
  updateSwapUI();

  Object.entries(palette).forEach(([key, rgb]) => {
    const item = document.createElement('div');
    item.className = 'swatch-item';
    const colorDiv = document.createElement('div');
    colorDiv.className = 'swatch-color';
    colorDiv.style.background = rgbToHex(...rgb);
    colorDiv.dataset.key = key;
    colorDiv.title = key;

    colorDiv.addEventListener('click', () => {
      selectForSwap(key, colorDiv, palette);
    });

    const lbl = document.createElement('div');
    lbl.className = 'swatch-label';
    lbl.textContent = key;
    item.appendChild(colorDiv);
    item.appendChild(lbl);
    ps.appendChild(item);
  });
}

let swapSelection = [null, null]; // [{key, el}, {key, el}]

function selectForSwap(key, el, palette) {
  // If already selected, deselect
  if (swapSelection[0] && swapSelection[0].key === key) {
    swapSelection[0] = null;
    el.classList.remove('swap-selected');
    updateSwapUI();
    return;
  }
  if (swapSelection[1] && swapSelection[1].key === key) {
    swapSelection[1] = null;
    el.classList.remove('swap-selected');
    updateSwapUI();
    return;
  }

  if (!swapSelection[0]) {
    swapSelection[0] = { key, el, palette };
    el.classList.add('swap-selected');
  } else if (!swapSelection[1]) {
    swapSelection[1] = { key, el, palette };
    el.classList.add('swap-selected');
  } else {
    // Replace second selection
    swapSelection[1].el.classList.remove('swap-selected');
    swapSelection[1] = { key, el, palette };
    el.classList.add('swap-selected');
  }
  updateSwapUI();
}

function updateSwapUI() {
  const slot1 = document.getElementById('swapSlot1');
  const slot2 = document.getElementById('swapSlot2');
  const swapBtn = document.getElementById('swapBtn');
  const swapHint = document.getElementById('swapHint');

  if (swapSelection[0]) {
    const p = swapSelection[0].palette || (customColors || selectedFlag.colors);
    const rgb = (customColors || selectedFlag.colors)[swapSelection[0].key];
    slot1.style.background = rgbToHex(...rgb);
    slot1.textContent = '';
    slot1.classList.add('filled');
    slot1.title = swapSelection[0].key;
  } else {
    slot1.style.background = '';
    slot1.textContent = '?';
    slot1.classList.remove('filled');
  }

  if (swapSelection[1]) {
    const rgb = (customColors || selectedFlag.colors)[swapSelection[1].key];
    slot2.style.background = rgbToHex(...rgb);
    slot2.textContent = '';
    slot2.classList.add('filled');
    slot2.title = swapSelection[1].key;
  } else {
    slot2.style.background = '';
    slot2.textContent = '?';
    slot2.classList.remove('filled');
  }

  const ready = swapSelection[0] && swapSelection[1];
  swapBtn.disabled = !ready;
  swapHint.textContent = ready
    ? `Swap "${swapSelection[0].key}" ⇄ "${swapSelection[1].key}"`
    : swapSelection[0] ? 'Now click a second color' : 'Click two swatches above to swap them';
}

document.getElementById('swapBtn').addEventListener('click', () => {
  if (!swapSelection[0] || !swapSelection[1]) return;
  if (!customColors) customColors = JSON.parse(JSON.stringify(selectedFlag.colors));

  const k1 = swapSelection[0].key, k2 = swapSelection[1].key;
  const tmp = [...customColors[k1]];
  customColors[k1] = [...customColors[k2]];
  customColors[k2] = tmp;

  // Update swatch visuals
  swapSelection[0].el.style.background = rgbToHex(...customColors[k1]);
  swapSelection[1].el.style.background = rgbToHex(...customColors[k2]);

  // Deselect and reprocess automatically
  swapSelection[0].el.classList.remove('swap-selected');
  swapSelection[1].el.classList.remove('swap-selected');
  swapSelection = [null, null];
  updateSwapUI();
  processImage(true);
});

async function processImage(useCustom = false) {
  if (!uploadedImage) return;
  processBtn.disabled = true;
  progressWrap.classList.add('visible');
  await sleep(10);

  canvas.width = uploadedImage.naturalWidth;
  canvas.height = uploadedImage.naturalHeight;
  ctx.drawImage(uploadedImage, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const W = canvas.width, H = canvas.height;

  setProgress(10, 'Classifying pixels...');
  await sleep(10);

  const flag = selectedFlag;
  const colorMap = flag.map();
  const palette = useCustom && customColors ? customColors : JSON.parse(JSON.stringify(flag.colors));
  const blendAmt = parseInt(blendSlider.value) / 100;
  const numSectors = parseInt(sectorSlider.value);
  const snapThresh = parseInt(snapSlider.value);

  const cx = W * 0.15, cy = H * 0.6;
  const n = W * H;
  const result = new Uint8ClampedArray(data);

  for (let i = 0; i < n; i++) {
    const idx = i*4;
    const r=data[idx], g=data[idx+1], b=data[idx+2];
    const gray=(r+g+b)/3;
    const sat=Math.max(r,g,b)-Math.min(r,g,b);
    const x=i%W, y=Math.floor(i/W);
    const angle=Math.atan2(y-cy, x-cx);
    const sector=Math.floor(angle/(Math.PI/(numSectors/2)));
    const isEven=((sector%2)+2)%2===0;

    const isRed=r>140&&r>g*1.8&&r>b*1.8&&sat>60;
    const isOrange=r>160&&g>80&&g<180&&b<80&&sat>60&&!isRed;
    const isBlack=gray<60&&sat<40;
    const isWhite=gray>180&&sat<50&&!isBlack;
    const isDgray=gray>=60&&gray<=180&&sat<40;
    const isBrown=r>100&&r<200&&g>50&&g<140&&b<60&&r>g*1.3&&g>b*1.3&&!isRed&&!isOrange;

    let tk=null;

    if(flag.rainbowMode && !isBlack) {
      const rKeys = flag.rainbowKeys || Object.keys(palette);
      const rSector = ((sector % rKeys.length) + rKeys.length) % rKeys.length;
      tk = rKeys[rSector];
    } else {
      if(isRed) tk=colorMap.red;
      else if(isOrange) tk=colorMap.orange;
      else if(isWhite) tk=isEven?colorMap.whiteBlue:colorMap.whitePink;
      else if(isBrown) tk=isEven?colorMap.brownBlue:colorMap.brownPink;
      else if(isDgray) tk=colorMap.dgray;
      else if(isBlack) tk=colorMap.black;
    }

    if(tk&&palette[tk]){
      const[tr,tg,tb]=palette[tk];
      result[idx]=r*(1-blendAmt)+tr*blendAmt;
      result[idx+1]=g*(1-blendAmt)+tg*blendAmt;
      result[idx+2]=b*(1-blendAmt)+tb*blendAmt;
    }
    if(i%200000===0){setProgress(10+(i/n)*50,'Remapping colors...');await sleep(0);}
  }

  setProgress(65,'Snapping transitional pixels...');
  await sleep(10);

  const pe=Object.values(palette);
  for(let i=0;i<n;i++){
    const idx=i*4;
    const r=result[idx],g=result[idx+1],b=result[idx+2];
    if((r+g+b)/3<20) continue;
    let minD=Infinity,nc=null;
    for(const[pr,pg,pb] of pe){const d=dist3(r,g,b,pr,pg,pb);if(d<minD){minD=d;nc=[pr,pg,pb];}}
    if(minD>snapThresh&&nc){result[idx]=nc[0];result[idx+1]=nc[1];result[idx+2]=nc[2];}
    if(i%200000===0){setProgress(65+(i/n)*25,'Snapping pixels...');await sleep(0);}
  }

  setProgress(92,'Cleaning dark remnants...');
  await sleep(10);

  for(let pass=0;pass<30;pass++){
    let changed=0;
    const temp=new Uint8ClampedArray(result);
    for(let y=1;y<H-1;y++){
      for(let x=1;x<W-1;x++){
        const idx=(y*W+x)*4;
        const r=temp[idx],g=temp[idx+1],b=temp[idx+2];
        const gray=(r+g+b)/3;
        if(gray>=80||gray<20) continue;
        if(!(r>b+10||gray<45)) continue;
        let sr=0,sg=0,sb=0,cnt=0;
        for(const[nx,ny] of[[x-1,y],[x+1,y],[x,y-1],[x,y+1]]){
          const ni=(ny*W+nx)*4;
          const ng=(temp[ni]+temp[ni+1]+temp[ni+2])/3;
          if(ng>=80){sr+=temp[ni];sg+=temp[ni+1];sb+=temp[ni+2];cnt++;}
        }
        if(cnt>0){result[idx]=sr/cnt;result[idx+1]=sg/cnt;result[idx+2]=sb/cnt;changed++;}
      }
    }
    if(changed===0) break;
  }

  setProgress(100,'Done!');
  await sleep(100);

  ctx.putImageData(new ImageData(result,W,H),0,0);
  const dataURL=canvas.toDataURL('image/png');

  document.getElementById('beforeThumb').src=uploadedImage.src;
  document.getElementById('afterThumb').src=dataURL;
  outputPanel.classList.add('visible');
  placeholderPanel.style.display='none';

  buildPaletteEditor(palette);

  document.getElementById('downloadBtn').onclick=()=>{
    const a=document.createElement('a');
    a.href=dataURL;
    a.download=`uv_${flag.id}_pride.png`;
    a.click();
  };

  processBtn.disabled=false;
  progressWrap.classList.remove('visible');
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
</script>
</body>
</html>
