<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UV Pride Remapper</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #2a2a3a;
    --text: #f0f0f8;
    --muted: #666680;
    --accent: #ff6eb4;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(255,110,180,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,110,180,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 48px 32px;
  }

  header {
    margin-bottom: 56px;
  }

  .title {
    font-family: 'Syne', sans-serif;
    font-size: clamp(2.2rem, 5vw, 3.8rem);
    font-weight: 800;
    letter-spacing: -0.02em;
    line-height: 1;
    background: linear-gradient(135deg, #ff6eb4 0%, #55cdfc 60%, #f7a8b8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle {
    margin-top: 12px;
    color: var(--muted);
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  @media (max-width: 700px) {
    .layout { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 28px;
  }

  .panel-label {
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
  }

  /* Drop zone */
  .dropzone {
    border: 1px dashed var(--border);
    border-radius: 4px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
  }

  .dropzone:hover, .dropzone.dragover {
    border-color: var(--accent);
    background: rgba(255,110,180,0.04);
  }

  .dropzone-icon {
    font-size: 2rem;
    margin-bottom: 12px;
    display: block;
  }

  .dropzone p {
    color: var(--muted);
    font-size: 0.75rem;
    line-height: 1.6;
  }

  .dropzone input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .preview-wrap {
    margin-top: 16px;
    border-radius: 4px;
    overflow: hidden;
    background: #000;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-wrap img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* Flag selector */
  .flag-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 24px;
  }

  .flag-btn {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 14px 12px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    text-align: left;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
  }

  .flag-btn:hover {
    border-color: #444460;
    background: #1a1a24;
  }

  .flag-btn.selected {
    border-color: var(--accent);
    background: rgba(255,110,180,0.08);
  }

  .flag-swatch {
    display: flex;
    height: 10px;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .flag-swatch span {
    flex: 1;
  }

  .flag-name {
    color: var(--text);
    font-weight: 700;
  }

  /* Process button */
  .btn {
    width: 100%;
    padding: 16px;
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: 4px;
    font-family: 'Space Mono', monospace;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }

  .btn:hover:not(:disabled) { opacity: 0.85; }
  .btn:active:not(:disabled) { transform: scale(0.99); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .btn.secondary {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    margin-top: 10px;
  }

  /* Progress */
  .progress-wrap {
    margin-top: 16px;
    display: none;
  }

  .progress-wrap.visible { display: block; }

  .progress-bar-bg {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff6eb4, #55cdfc);
    width: 0%;
    transition: width 0.3s;
    border-radius: 2px;
  }

  .progress-label {
    font-size: 0.65rem;
    color: var(--muted);
    margin-top: 8px;
    letter-spacing: 0.1em;
  }

  /* Output */
  .output-panel {
    grid-column: 1 / -1;
    display: none;
  }

  .output-panel.visible { display: block; }

  .output-inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 700px) {
    .output-inner { grid-template-columns: 1fr; }
  }

  canvas { display: none; }

  .tag {
    display: inline-block;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
    margin-bottom: 12px;
  }

  .tag.before { background: rgba(255,255,255,0.05); color: var(--muted); }
  .tag.after { background: rgba(255,110,180,0.15); color: var(--accent); }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1 class="title">UV Pride<br>Remapper</h1>
    <p class="subtitle">Recolor UV texture maps with pride flag palettes</p>
  </header>

  <div class="layout">
    <!-- Upload -->
    <div class="panel">
      <div class="panel-label">01 — Upload UV Map</div>
      <div class="dropzone" id="dropzone">
        <input type="file" id="fileInput" accept="image/*">
        <span class="dropzone-icon">⬡</span>
        <p>Drop your UV map here<br>or click to browse<br><br>PNG, JPG, TGA supported</p>
      </div>
      <div class="preview-wrap" id="inputPreview" style="display:none">
        <img id="inputImg" alt="Input UV map">
      </div>
    </div>

    <!-- Flag + Controls -->
    <div class="panel">
      <div class="panel-label">02 — Choose Flag</div>
      <div class="flag-grid" id="flagGrid"></div>

      <button class="btn" id="processBtn" disabled>Process →</button>

      <div class="progress-wrap" id="progressWrap">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">Analyzing pixels...</div>
      </div>
    </div>

    <!-- Output -->
    <div class="panel output-panel" id="outputPanel">
      <div class="panel-label">03 — Result</div>
      <div class="output-inner">
        <div>
          <div class="tag before">Before</div>
          <div class="preview-wrap">
            <img id="beforeThumb" alt="Before">
          </div>
        </div>
        <div>
          <div class="tag after">After</div>
          <div class="preview-wrap">
            <img id="afterThumb" alt="After">
          </div>
        </div>
      </div>
      <button class="btn secondary" id="downloadBtn">↓ Download PNG</button>
    </div>
  </div>
</div>

<canvas id="canvas"></canvas>

<script>
const FLAGS = [
  {
    id: 'trans',
    name: 'Trans Pride',
    swatches: ['#55cdfc','#f7a8b8','#ffffff','#f7a8b8','#55cdfc'],
    colors: {
      pink:  [247, 168, 184],
      blue:  [85,  205, 252],
      white: [255, 255, 255],
      slate: [110, 160, 200],
    },
    map: (masks, sectors) => ({
      red:    'pink',
      orange: 'blue',
      whitePink: 'pink',
      whiteBlue: 'blue',
      brownPink: 'pink',
      brownBlue: 'blue',
      dgray:  'slate',
      black:  'white',
    })
  },
  {
    id: 'rainbow',
    name: 'Rainbow',
    swatches: ['#e40303','#ff8c00','#ffed00','#008026','#004dff','#750787'],
    colors: {
      red:    [228,  3,   3],
      orange: [255, 140,  0],
      yellow: [255, 237,  0],
      green:  [0,   128, 38],
      blue:   [0,    77,255],
      violet: [117,  7, 135],
    },
    map: () => ({
      red:    'red',
      orange: 'orange',
      whitePink: 'yellow',
      whiteBlue: 'green',
      brownPink: 'blue',
      brownBlue: 'violet',
      dgray:  'blue',
      black:  'violet',
    })
  },
  {
    id: 'bi',
    name: 'Bi Pride',
    swatches: ['#d60270','#d60270','#9b4f96','#0038a8','#0038a8'],
    colors: {
      pink:   [214,  2, 112],
      purple: [155, 79, 150],
      blue:   [0,   56, 168],
      white:  [255,255,255],
    },
    map: () => ({
      red:    'pink',
      orange: 'blue',
      whitePink: 'pink',
      whiteBlue: 'blue',
      brownPink: 'purple',
      brownBlue: 'blue',
      dgray:  'purple',
      black:  'white',
    })
  },
  {
    id: 'nonbinary',
    name: 'Non-Binary',
    swatches: ['#fcf434','#ffffff','#9c59d1','#2d2d2d'],
    colors: {
      yellow: [252, 244, 52],
      white:  [255, 255,255],
      purple: [156, 89, 209],
      dark:   [45,  45,  45],
    },
    map: () => ({
      red:    'yellow',
      orange: 'purple',
      whitePink: 'white',
      whiteBlue: 'yellow',
      brownPink: 'purple',
      brownBlue: 'yellow',
      dgray:  'purple',
      black:  'dark',
    })
  },
  {
    id: 'lesbian',
    name: 'Lesbian',
    swatches: ['#d52d00','#ef7627','#ff9a56','#ffffff','#d162a4','#b55690','#a50062'],
    colors: {
      orange:  [239, 118, 39],
      peach:   [255, 154, 86],
      white:   [255, 255,255],
      pink:    [209, 98, 164],
      magenta: [165,  0,  98],
    },
    map: () => ({
      red:    'magenta',
      orange: 'orange',
      whitePink: 'peach',
      whiteBlue: 'pink',
      brownPink: 'orange',
      brownBlue: 'pink',
      dgray:  'pink',
      black:  'white',
    })
  },
  {
    id: 'pan',
    name: 'Pan Pride',
    swatches: ['#ff218c','#ff218c','#ffd800','#ffd800','#21b1ff'],
    colors: {
      pink:   [255,  33,140],
      yellow: [255, 216,  0],
      blue:   [33,  177,255],
      white:  [255, 255,255],
    },
    map: () => ({
      red:    'pink',
      orange: 'yellow',
      whitePink: 'pink',
      whiteBlue: 'blue',
      brownPink: 'yellow',
      brownBlue: 'blue',
      dgray:  'blue',
      black:  'white',
    })
  },
  {
    id: 'ace',
    name: 'Asexual',
    swatches: ['#1a1a1a','#a3a3a3','#ffffff','#810081'],
    colors: {
      black:  [26,   26,  26],
      gray:   [163, 163, 163],
      white:  [255, 255, 255],
      purple: [129,   0, 129],
    },
    map: () => ({
      red:    'purple',
      orange: 'gray',
      whitePink: 'white',
      whiteBlue: 'gray',
      brownPink: 'purple',
      brownBlue: 'gray',
      dgray:  'gray',
      black:  'black',
    })
  },
  {
    id: 'gaymen',
    name: 'Gay Men',
    swatches: ['#078d70','#26ceaa','#98e8c1','#ffffff','#7bade2','#5049cc','#3d1a8e'],
    colors: {
      teal:   [7,   141, 112],
      mint:   [38,  206, 170],
      seafoam:[152, 232, 193],
      white:  [255, 255, 255],
      periwinkle: [123, 173, 226],
      indigo: [80,   73, 204],
      navy:   [61,   26, 142],
    },
    map: () => ({
      red:    'indigo',
      orange: 'teal',
      whitePink: 'seafoam',
      whiteBlue: 'periwinkle',
      brownPink: 'mint',
      brownBlue: 'indigo',
      dgray:  'navy',
      black:  'white',
    })
  },
  {
    id: 'progress',
    name: 'Progress Pride',
    swatches: ['#e40303','#ff8c00','#ffed00','#008026','#004dff','#750787','#ffffff','#f7a8b8','#55cdfc','#613915','#1a1a1a'],
    colors: {
      red:    [228,   3,   3],
      orange: [255, 140,   0],
      yellow: [255, 237,   0],
      green:  [0,   128,  38],
      blue:   [0,    77, 255],
      violet: [117,   7, 135],
      white:  [255, 255, 255],
      tpink:  [247, 168, 184],
      tblue:  [85,  205, 252],
      brown:  [97,   57,  21],
      black:  [26,   26,  26],
    },
    map: () => ({
      red:    'red',
      orange: 'orange',
      whitePink: 'tpink',
      whiteBlue: 'tblue',
      brownPink: 'brown',
      brownBlue: 'violet',
      dgray:  'blue',
      black:  'black',
    })
  },
];

// Build flag buttons
const flagGrid = document.getElementById('flagGrid');
let selectedFlag = FLAGS[0];

FLAGS.forEach(flag => {
  const btn = document.createElement('button');
  btn.className = 'flag-btn' + (flag.id === selectedFlag.id ? ' selected' : '');
  btn.dataset.id = flag.id;

  const swatch = document.createElement('div');
  swatch.className = 'flag-swatch';
  flag.swatches.forEach(c => {
    const s = document.createElement('span');
    s.style.background = c;
    swatch.appendChild(s);
  });

  const name = document.createElement('div');
  name.className = 'flag-name';
  name.textContent = flag.name;

  btn.appendChild(swatch);
  btn.appendChild(name);
  btn.addEventListener('click', () => {
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedFlag = flag;
  });
  flagGrid.appendChild(btn);
});

// File upload
let uploadedImage = null;
const fileInput = document.getElementById('fileInput');
const dropzone = document.getElementById('dropzone');
const inputPreview = document.getElementById('inputPreview');
const inputImg = document.getElementById('inputImg');
const processBtn = document.getElementById('processBtn');

dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) loadFile(file);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) loadFile(fileInput.files[0]);
});

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      uploadedImage = img;
      inputImg.src = e.target.result;
      inputPreview.style.display = 'flex';
      processBtn.disabled = false;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Processing
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const progressWrap = document.getElementById('progressWrap');
const progressFill = document.getElementById('progressFill');
const progressLabel = document.getElementById('progressLabel');
const outputPanel = document.getElementById('outputPanel');
const beforeThumb = document.getElementById('beforeThumb');
const afterThumb = document.getElementById('afterThumb');
const downloadBtn = document.getElementById('downloadBtn');

processBtn.addEventListener('click', () => processImage());

function setProgress(pct, label) {
  progressFill.style.width = pct + '%';
  progressLabel.textContent = label;
}

function dist3(r1,g1,b1, r2,g2,b2) {
  return Math.sqrt((r1-r2)**2 + (g1-g2)**2 + (b1-b2)**2);
}

async function processImage() {
  if (!uploadedImage) return;
  processBtn.disabled = true;
  progressWrap.classList.add('visible');
  outputPanel.classList.remove('visible');

  await sleep(10);

  // Draw to canvas
  canvas.width = uploadedImage.naturalWidth;
  canvas.height = uploadedImage.naturalHeight;
  ctx.drawImage(uploadedImage, 0, 0);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const W = canvas.width, H = canvas.height;

  setProgress(10, 'Classifying pixels...');
  await sleep(10);

  const flag = selectedFlag;
  const colorMap = flag.map();
  const palette = flag.colors;

  // Center for sector calculation (same as Python script)
  const cx = W * 0.15;
  const cy = H * 0.6;

  // Classify each pixel
  const n = W * H;
  const result = new Uint8ClampedArray(data);

  // First pass: remap colored regions
  for (let i = 0; i < n; i++) {
    const idx = i * 4;
    const r = data[idx], g = data[idx+1], b = data[idx+2];
    const gray = (r + g + b) / 3;
    const maxC = Math.max(r,g,b), minC = Math.min(r,g,b);
    const sat = maxC - minC;

    const x = i % W, y = Math.floor(i / W);
    const angle = Math.atan2(y - cy, x - cx);
    const sector = Math.floor(angle / (Math.PI / 12));
    const isEven = ((sector % 2) + 2) % 2 === 0;

    let targetKey = null;

    const isRed    = r > 140 && r > g * 1.8 && r > b * 1.8 && sat > 60;
    const isOrange = r > 160 && g > 80 && g < 180 && b < 80 && sat > 60 && !isRed;
    const isBlack  = gray < 60 && sat < 40;
    const isWhite  = gray > 180 && sat < 50 && !isBlack;
    const isDgray  = gray >= 60 && gray <= 180 && sat < 40;
    const isBrown  = r > 100 && r < 200 && g > 50 && g < 140 && b < 60 
                     && r > g * 1.3 && g > b * 1.3 && !isRed && !isOrange;

    if (isRed)         targetKey = colorMap.red;
    else if (isOrange) targetKey = colorMap.orange;
    else if (isWhite)  targetKey = isEven ? colorMap.whiteBlue : colorMap.whitePink;
    else if (isBrown)  targetKey = isEven ? colorMap.brownBlue : colorMap.brownPink;
    else if (isDgray)  targetKey = colorMap.dgray;
    else if (isBlack)  targetKey = colorMap.black;

    if (targetKey && palette[targetKey]) {
      const [tr, tg, tb] = palette[targetKey];
      // For white regions use blend
      const blend = (isWhite) ? 0.65 : 1.0;
      result[idx]   = r * (1-blend) + tr * blend;
      result[idx+1] = g * (1-blend) + tg * blend;
      result[idx+2] = b * (1-blend) + tb * blend;
    }

    if (i % 200000 === 0) {
      setProgress(10 + (i/n)*50, 'Remapping colors...');
      await sleep(0);
    }
  }

  setProgress(65, 'Snapping transitional pixels...');
  await sleep(10);

  // Build palette array for snapping
  const paletteEntries = Object.values(palette);

  // Second pass: snap transitional pixels to nearest palette color
  for (let i = 0; i < n; i++) {
    const idx = i * 4;
    const r = result[idx], g = result[idx+1], b = result[idx+2];
    const gray = (r + g + b) / 3;
    if (gray < 20) continue; // background

    // Find nearest palette color
    let minD = Infinity, nearColor = null;
    for (const [pr, pg, pb] of paletteEntries) {
      const d = dist3(r,g,b, pr,pg,pb);
      if (d < minD) { minD = d; nearColor = [pr,pg,pb]; }
    }

    if (minD > 35 && nearColor) {
      result[idx]   = nearColor[0];
      result[idx+1] = nearColor[1];
      result[idx+2] = nearColor[2];
    }

    if (i % 200000 === 0) {
      setProgress(65 + (i/n)*25, 'Snapping pixels...');
      await sleep(0);
    }
  }

  setProgress(92, 'Cleaning dark remnants...');
  await sleep(10);

  // Third pass: iterative dark remnant removal (5 passes)
  for (let pass = 0; pass < 8; pass++) {
    let changed = 0;
    const temp = new Uint8ClampedArray(result);
    for (let y = 1; y < H-1; y++) {
      for (let x = 1; x < W-1; x++) {
        const idx = (y*W+x)*4;
        const r = temp[idx], g = temp[idx+1], b = temp[idx+2];
        const gray = (r+g+b)/3;
        if (gray >= 80 || (gray < 20)) continue;
        if (!(r > b + 10 || gray < 45)) continue;

        // Average non-dark neighbors
        let sr=0,sg=0,sb=0,cnt=0;
        for (const [nx,ny] of [[x-1,y],[x+1,y],[x,y-1],[x,y+1]]) {
          const ni = (ny*W+nx)*4;
          const ng = (temp[ni]+temp[ni+1]+temp[ni+2])/3;
          if (ng >= 80) { sr+=temp[ni]; sg+=temp[ni+1]; sb+=temp[ni+2]; cnt++; }
        }
        if (cnt > 0) {
          result[idx]   = sr/cnt;
          result[idx+1] = sg/cnt;
          result[idx+2] = sb/cnt;
          changed++;
        }
      }
    }
    if (changed === 0) break;
  }

  setProgress(100, 'Done!');
  await sleep(100);

  // Output
  const outImageData = new ImageData(result, W, H);
  ctx.putImageData(outImageData, 0, 0);
  const dataURL = canvas.toDataURL('image/png');

  beforeThumb.src = uploadedImage.src;
  afterThumb.src = dataURL;
  outputPanel.classList.add('visible');

  downloadBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = dataURL;
    a.download = `uv_${flag.id}_pride.png`;
    a.click();
  };

  processBtn.disabled = false;
  progressWrap.classList.remove('visible');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
